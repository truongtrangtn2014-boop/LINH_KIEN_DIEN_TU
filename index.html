<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>·ª®ng d·ª•ng AI nh·∫≠n di·ªán linh ki·ªán ƒëi·ªán t·ª≠</title>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest"></script>
  <script src="data.js"></script>
  <style>
    body {
      font-family: "Segoe UI", Arial, sans-serif;
      background: #f2f6ff;
      margin: 0;
      padding: 0;
      text-align: center;
      color: #222;
    }

    header {
      background: #0066ff;
      color: white;
      padding: 15px;
      border-bottom: 4px solid #004bcc;
    }

    h1 {
      margin: 0;
      font-size: 20px;
    }

    h2 {
      margin: 0;
      font-size: 16px;
      font-weight: normal;
    }

    main {
      margin: 15px auto;
      max-width: 400px;
      background: white;
      padding: 15px;
      border-radius: 15px;
      box-shadow: 0 0 8px rgba(0,0,0,0.1);
    }

    input, button {
      font-size: 15px;
      margin: 5px;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
    }

    button {
      background: #007bff;
      color: white;
      border: none;
      cursor: pointer;
    }

    button:hover {
      background: #005ec2;
    }

    #webcam-container {
      margin-top: 10px;
    }

    #info-box {
      text-align: left;
      margin-top: 15px;
      background: #f4f7ff;
      padding: 10px 15px;
      border-radius: 10px;
    }

    #quiz-box {
      margin-top: 15px;
      text-align: left;
      background: #eef3ff;
      padding: 15px;
      border-radius: 12px;
    }

    footer {
      margin-top: 20px;
      font-size: 13px;
      color: #666;
    }
  </style>
</head>

<body>
  <header>
    <h1>·ª®NG D·ª§NG AI NH·∫¨N DI·ªÜN LINH KI·ªÜN ƒêI·ªÜN T·ª¨</h1>
    <h2>Tr∆∞·ªùng THPT Tr·∫ßn Qu·ªëc Tu·∫•n</h2>
  </header>

  <main>
    <h3>Nh·∫≠p th√¥ng tin h·ªçc sinh</h3>
    <input id="name" placeholder="H·ªç v√† t√™n" style="width: 90%"><br>
    <input id="class" placeholder="L·ªõp" style="width: 90%"><br><br>

    <button onclick="init()">üì∑ B·∫≠t camera</button>
    <button onclick="stopCam()">‚è∏Ô∏è D·ª´ng</button>
    <button onclick="switchCam()">üîÑ Chuy·ªÉn camera</button>

    <div id="webcam-container"></div>
    <div id="label-container" style="margin-top:10px;">Camera ch∆∞a b·∫≠t.</div>

    <div id="info-box">
      <p><b>T√™n linh ki·ªán:</b> <span id="ten">‚Äî</span></p>
      <p><b>C√¥ng d·ª•ng:</b> <span id="congDung">‚Äî</span></p>
      <p><b>Nguy√™n l√Ω ho·∫°t ƒë·ªông:</b> <span id="nguyenLy">‚Äî</span></p>
    </div>
  </main>

  <footer>
    ¬© 2025 Tr∆∞·ªùng THPT Tr·∫ßn Qu·ªëc Tu·∫•n ‚Äî ·ª®ng d·ª•ng AI trong d·∫°y h·ªçc C√¥ng ngh·ªá
  </footer>

  <!-- ========== SCRIPT X·ª¨ L√ù CH√çNH ========== -->
  <script>
    const URL = "https://teachablemachine.withgoogle.com/models/PASTE_YOUR_MODEL_HERE/"; // üîÅ Thay link model c·ªßa Th·∫ßy/C√¥
    let model, webcam, labelContainer, maxPredictions;
    let flip = true, isRunning = false;
    let currentLabel = null;

    // ======= KH·ªûI T·∫†O CAMERA =======
    async function init() {
      if (isRunning) return;
      isRunning = true;

      const modelURL = URL + "model.json";
      const metadataURL = URL + "metadata.json";

      model = await tmImage.load(modelURL, metadataURL);
      maxPredictions = model.getTotalClasses();

      webcam = new tmImage.Webcam(300, 300, flip);
      await webcam.setup();
      await webcam.play();
      window.requestAnimationFrame(loop);

      document.getElementById("webcam-container").innerHTML = "";
      document.getElementById("webcam-container").appendChild(webcam.canvas);
      labelContainer = document.getElementById("label-container");
      labelContainer.innerHTML = "üé• Camera ƒëang ho·∫°t ƒë·ªông...";
    }

    async function loop() {
      if (!isRunning) return;
      webcam.update();
      await predict();
      window.requestAnimationFrame(loop);
    }

    // ======= D·ª∞ ƒêO√ÅN =======
    async function predict() {
      const prediction = await model.predict(webcam.canvas);
      prediction.sort((a,b)=>b.probability - a.probability);
      const label = prediction[0].className;
      const prob = prediction[0].probability * 100;

      if (prob > 80 && label !== currentLabel) {
        currentLabel = label;
        const info = device_data[label];
        if (info) {
          document.getElementById("ten").textContent = label;
          document.getElementById("congDung").textContent = info.cong_dung;
          document.getElementById("nguyenLy").textContent = info.nguyen_ly;
          showQuiz(label);
        }
      }
    }

    // ======= TR·∫ÆC NGHI·ªÜM =======
    function showQuiz(label) {
      const quizBox = document.createElement("div");
      quizBox.id = "quiz-box";
      quizBox.style.marginTop = "15px";
      const quiz = device_data[label].quiz;
      let html = `<h3>üß© C√¢u h·ªèi tr·∫Øc nghi·ªám</h3>`;
      quiz.forEach((q, i) => {
        html += `<p><b>${i+1}. ${q.question}</b></p>`;
        q.options.forEach(opt => {
          html += `<label><input type='radio' name='q${i}' value='${opt}'> ${opt}</label><br>`;
        });
      });
      html += `<br><button onclick="submitQuiz('${label}')">üì§ G·ª≠i k·∫øt qu·∫£</button>`;
      quizBox.innerHTML = html;

      const old = document.getElementById("quiz-box");
      if (old) old.remove();
      document.querySelector("main").appendChild(quizBox);
    }

    // ======= N·ªòP K·∫æT QU·∫¢ =======
    function submitQuiz(label) {
      const name = document.getElementById("name").value.trim();
      const lop = document.getElementById("class").value.trim();
      if (!name || !lop) {
        alert("Vui l√≤ng nh·∫≠p h·ªç t√™n v√† l·ªõp tr∆∞·ªõc khi l√†m b√†i!");
        return;
      }

      const quiz = device_data[label].quiz;
      let score = 0;
      quiz.forEach((q, i) => {
        const ans = document.querySelector(`input[name='q${i}']:checked`);
        if (ans && ans.value === q.answer) score++;
      });
      const total = quiz.length;
      const percent = ((score / total) * 100).toFixed(0);

      alert(`‚úÖ B·∫°n tr·∫£ l·ªùi ƒë√∫ng ${score}/${total} c√¢u (${percent}%).`);
      saveToSheet(name, lop, label, percent);
    }

    // ======= G·ª¨I D·ªÆ LI·ªÜU L√äN GOOGLE SHEET =======
    function saveToSheet(name, lop, linhkien, percent) {
      const scriptURL = "https://script.google.com/macros/s/PASTE_YOUR_SCRIPT_ID_HERE/exec"; // üîÅ Thay link script
      const data = new FormData();
      data.append("name", name);
      data.append("class", lop);
      data.append("linhkien", linhkien);
      data.append("score", percent);

      fetch(scriptURL, { method: "POST", body: data })
        .then(() => alert("üìä K·∫øt qu·∫£ ƒë√£ g·ª≠i l√™n Google Sheet!"))
        .catch(() => alert("‚ö†Ô∏è Kh√¥ng g·ª≠i ƒë∆∞·ª£c k·∫øt qu·∫£, vui l√≤ng ki·ªÉm tra l·∫°i."));
    }

    // ======= D·ª™NG CAMERA =======
    function stopCam() {
      if (webcam && isRunning) {
        webcam.stop();
        isRunning = false;
        document.getElementById("label-container").innerText = "‚è∏Ô∏è Camera ƒë√£ d·ª´ng.";
      }
    }

    async function switchCam() {
      flip = !flip;
      stopCam();
      await init();
    }
  </script>
</body>
</html>
